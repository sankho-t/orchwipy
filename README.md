# OrchWiPy

Create data orchestration pipelines over AWS Lambda functions from within python code using decorators.

- No need for separate definition file, you define the orchestration + lambda functions in the code
- Simpler data passing: only return changes to current state rather than the whole state
- Visualize flow graph
- Statically check state passing between steps
- Generate AWS cloudformation template automatically
- Run locally
- Handle lambda invocation payload size limit transparently

We developed _OrchWiPy_ at [ask-next.com](https://ask-next.com)

# Example

```python
from orchwipy import MicroFunctions, ConditionalReturns, ReturnUpdates
from orchwipy import build_cfn_template

# Our pipeline starts at function 'start'
pipe = MicroFunctions(beginner="start")

@pipe.fn()
# pipe.fn() will convert this to a lambda function when deployed
def start(*, choice: str | None, **kwargs):
    # **kwargs is always needed

    beans = None
    if not choice:
        choice = input("Tea or coffee? (t/c)")
    if choice == 'c':
        beans = int(input("How much beans "))

    # if choice is 'c', then we go to 'coffee' else 'tea'
    return ConditionalReturns(
                choice,
                # default choice is 'tea'
                # "*" => passing no other arguments, required for first step
                ReturnUpdates("tea", "*"),
                # only include beans argument
                c=ReturnUpdates("coffee", "*", beans=beans))

@pipe.fn(template_props=dict(Layers=[{"Ref": 'MorePythonPackagesLayer'}]))
# MorePythonPackagesLayer will become a CFN template parameter
def tea(**kwargs):
    print("Have tea")
    # can also return a dictionary, with $next as the next function name
    return {"$next": "coffee", "beans": 5}

@pipe.fn()
def coffee(*, beans: int, **kwargs):
    print(f"Put {beans} beans into the coffee machine")
    # include all the arguments passed previously and add (update) the milk argument
    return ReturnUpdates("drink", milk=True)

@pipe.fn(terminates=True)
# terminates => specify that this may be the end of the pipe
def drink(*, milk: bool | None, **kwargs):
    if milk:
        print("Add some milk if its bitter")
    print("Drink!")
    return {}

# boilerplate: pass execution to pipe when running in AWS lambda
def lambda_handler(event, context):
    pipe.lambda_handler(event, context)

if __name__ == "__main__":
    pipe.check_graph("start")

    # local run
    pipe.run(choice=None)

    # check execution pipeline and generate a graphviz graph for visualization
    with open("example.dot", "w") as f:
        pipe.save_dot(f, top_node="start")

    # generate a aws cloudformation template for deployment
    with open("example.template.yml", 'w') as f:
        build_cfn_template(
            output_template=f,
            code_py_relative_to_template=__file__.split("/")[-1],
            plant=pipe,
            layers=[],
            policies=[],
        )

```

## Visualization

It generates a graphviz dot diagram `example.dot`:

<html>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="106pt" height="332pt"
 viewBox="0.00 0.00 105.62 332.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<polygon fill="white" stroke="none" points="-4,4 -4,-328 101.62,-328 101.62,4 -4,4"/>
<!-- start -->
<g id="node1" class="node">
<title>start</title>
<ellipse fill="none" stroke="black" cx="54" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="54" y="-300.95" font-family="Times,serif" font-size="14.00">start</text>
</g>
<!-- cond1 -->
<g id="node5" class="node">
<title>cond1</title>
<polygon fill="#a0e5e5" fill-opacity="0.498039" stroke="#a0e5e5" stroke-opacity="0.498039" points="97.62,-252 10.38,-252 10.38,-216 97.62,-216 97.62,-252"/>
<text text-anchor="middle" x="54" y="-228.95" font-family="Times,serif" font-size="14.00">choice = &#39;c&#39; ?</text>
</g>
<!-- start&#45;&gt;cond1 -->
<g id="edge1" class="edge">
<title>start&#45;&gt;cond1</title>
<path fill="none" stroke="black" d="M54,-287.7C54,-280.41 54,-271.73 54,-263.54"/>
<polygon fill="black" stroke="black" points="57.5,-263.62 54,-253.62 50.5,-263.62 57.5,-263.62"/>
</g>
<!-- tea -->
<g id="node2" class="node">
<title>tea</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="27" y="-156.95" font-family="Times,serif" font-size="14.00">tea</text>
</g>
<!-- coffee -->
<g id="node3" class="node">
<title>coffee</title>
<ellipse fill="none" stroke="black" cx="54" cy="-90" rx="33.95" ry="18"/>
<text text-anchor="middle" x="54" y="-84.95" font-family="Times,serif" font-size="14.00">coffee</text>
</g>
<!-- tea&#45;&gt;coffee -->
<g id="edge2" class="edge">
<title>tea&#45;&gt;coffee</title>
<path fill="none" stroke="black" d="M33.54,-144.05C36.52,-136.32 40.13,-126.96 43.48,-118.27"/>
<polygon fill="black" stroke="black" points="46.65,-119.79 46.98,-109.2 40.12,-117.27 46.65,-119.79"/>
</g>
<!-- drink -->
<g id="node4" class="node">
<title>drink</title>
<ellipse fill="none" stroke="black" cx="54" cy="-18" rx="30.37" ry="18"/>
<text text-anchor="middle" x="54" y="-12.95" font-family="Times,serif" font-size="14.00">drink</text>
</g>
<!-- coffee&#45;&gt;drink -->
<g id="edge3" class="edge">
<title>coffee&#45;&gt;drink</title>
<path fill="none" stroke="black" d="M54,-71.7C54,-64.41 54,-55.73 54,-47.54"/>
<polygon fill="black" stroke="black" points="57.5,-47.62 54,-37.62 50.5,-47.62 57.5,-47.62"/>
</g>
<!-- cond1&#45;&gt;tea -->
<g id="edge5" class="edge">
<title>cond1&#45;&gt;tea</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M47.33,-215.7C44.37,-208.04 40.83,-198.85 37.53,-190.3"/>
<polygon fill="black" stroke="black" points="40.82,-189.1 33.96,-181.03 34.29,-191.62 40.82,-189.1"/>
</g>
<!-- cond1&#45;&gt;coffee -->
<g id="edge4" class="edge">
<title>cond1&#45;&gt;coffee</title>
<path fill="none" stroke="black" d="M57.65,-215.91C59.68,-205.57 61.98,-192.09 63,-180 64.34,-164.06 64.34,-159.94 63,-144 62.32,-135.97 61.08,-127.33 59.73,-119.4"/>
<polygon fill="black" stroke="black" points="63.17,-118.79 57.93,-109.58 56.29,-120.05 63.17,-118.79"/>
</g>
</g>
</svg>

</html>

## Static checking

This involves checking all the execution paths to ensure that all the required function arguments are passed through all possible invocations.

In the above example, if we replace this line in function `tea`:

```python
    return {"$next": "coffee", "beans": 5}
```

with

```python
    return {"$next": "coffee"}
```

then the `coffee` step will not receive the `beans` argument when execution flows through `start -> tea -> coffee `. Invoking `pipe.check_graph(start_at="start")` will throw us this warning:

```
:0: MissingArgument: {'beans'} : caller history ['start', 'tea'] -> coffee
```

# More Examples

_tests/sample.py_ is another example:

<html>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="375pt" height="548pt"
 viewBox="0.00 0.00 374.61 548.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 544)">
<polygon fill="white" stroke="none" points="-4,4 -4,-544 370.61,-544 370.61,4 -4,4"/>
<!-- welcome -->
<g id="node1" class="node">
<title>welcome</title>
<ellipse fill="none" stroke="black" cx="193.42" cy="-522" rx="44.7" ry="18"/>
<text text-anchor="middle" x="193.42" y="-516.95" font-family="Times,serif" font-size="14.00">welcome</text>
</g>
<!-- cond1 -->
<g id="node10" class="node">
<title>cond1</title>
<polygon fill="#a0e5a0" fill-opacity="0.498039" stroke="#a0e5a0" stroke-opacity="0.498039" points="114.92,-468 29.92,-468 29.92,-432 114.92,-432 114.92,-468"/>
<text text-anchor="middle" x="72.42" y="-444.95" font-family="Times,serif" font-size="14.00">choice = &#39;t&#39; ?</text>
</g>
<!-- welcome&#45;&gt;cond1 -->
<g id="edge1" class="edge">
<title>welcome&#45;&gt;cond1</title>
<path fill="none" stroke="black" d="M168.64,-506.67C152.35,-497.24 130.67,-484.7 112.02,-473.91"/>
<polygon fill="black" stroke="black" points="114.02,-471.02 103.61,-469.04 110.52,-477.08 114.02,-471.02"/>
</g>
<!-- cond2 -->
<g id="node11" class="node">
<title>cond2</title>
<polygon fill="#a0e5a0" fill-opacity="0.498039" stroke="#a0e5a0" stroke-opacity="0.498039" points="237.05,-468 149.8,-468 149.8,-432 237.05,-432 237.05,-468"/>
<text text-anchor="middle" x="193.42" y="-444.95" font-family="Times,serif" font-size="14.00">choice = &#39;c&#39; ?</text>
</g>
<!-- welcome&#45;&gt;cond2 -->
<g id="edge2" class="edge">
<title>welcome&#45;&gt;cond2</title>
<path fill="none" stroke="black" d="M193.42,-503.7C193.42,-496.41 193.42,-487.73 193.42,-479.54"/>
<polygon fill="black" stroke="black" points="196.92,-479.62 193.42,-469.62 189.92,-479.62 196.92,-479.62"/>
</g>
<!-- cond3 -->
<g id="node12" class="node">
<title>cond3</title>
<polygon fill="#a0e5a0" fill-opacity="0.498039" stroke="#a0e5a0" stroke-opacity="0.498039" points="351.17,-468 267.67,-468 267.67,-432 351.17,-432 351.17,-468"/>
<text text-anchor="middle" x="309.42" y="-444.95" font-family="Times,serif" font-size="14.00">choice = * ?</text>
</g>
<!-- welcome&#45;&gt;cond3 -->
<g id="edge3" class="edge">
<title>welcome&#45;&gt;cond3</title>
<path fill="none" stroke="black" d="M217.46,-506.5C232.91,-497.17 253.33,-484.85 271.01,-474.18"/>
<polygon fill="black" stroke="black" points="272.44,-477.4 279.2,-469.24 268.83,-471.41 272.44,-477.4"/>
</g>
<!-- making_tea -->
<g id="node2" class="node">
<title>making_tea</title>
<ellipse fill="none" stroke="black" cx="54.42" cy="-378" rx="54.42" ry="18"/>
<text text-anchor="middle" x="54.42" y="-372.95" font-family="Times,serif" font-size="14.00">making_tea</text>
</g>
<!-- boil_water -->
<g id="node5" class="node">
<title>boil_water</title>
<ellipse fill="none" stroke="black" cx="123.42" cy="-306" rx="50.33" ry="18"/>
<text text-anchor="middle" x="123.42" y="-300.95" font-family="Times,serif" font-size="14.00">boil_water</text>
</g>
<!-- making_tea&#45;&gt;boil_water -->
<g id="edge4" class="edge">
<title>making_tea&#45;&gt;boil_water</title>
<path fill="none" stroke="black" d="M70.77,-360.41C79.28,-351.78 89.85,-341.06 99.28,-331.5"/>
<polygon fill="black" stroke="black" points="101.6,-334.13 106.13,-324.55 96.61,-329.21 101.6,-334.13"/>
</g>
<!-- making_coffee -->
<g id="node3" class="node">
<title>making_coffee</title>
<ellipse fill="none" stroke="black" cx="193.42" cy="-378" rx="66.71" ry="18"/>
<text text-anchor="middle" x="193.42" y="-372.95" font-family="Times,serif" font-size="14.00">making_coffee</text>
</g>
<!-- making_coffee&#45;&gt;boil_water -->
<g id="edge5" class="edge">
<title>making_coffee&#45;&gt;boil_water</title>
<path fill="none" stroke="black" d="M176.83,-360.41C168.2,-351.78 157.48,-341.06 147.92,-331.5"/>
<polygon fill="black" stroke="black" points="150.51,-329.14 140.96,-324.54 145.56,-334.09 150.51,-329.14"/>
</g>
<!-- nochoice -->
<g id="node4" class="node">
<title>nochoice</title>
<ellipse fill="none" stroke="black" cx="322.42" cy="-378" rx="44.19" ry="18"/>
<text text-anchor="middle" x="322.42" y="-372.95" font-family="Times,serif" font-size="14.00">nochoice</text>
</g>
<!-- cond4 -->
<g id="node13" class="node">
<title>cond4</title>
<polygon fill="#a0a0e5" fill-opacity="0.498039" stroke="#a0a0e5" stroke-opacity="0.498039" points="180.92,-252 65.92,-252 65.92,-216 180.92,-216 180.92,-252"/>
<text text-anchor="middle" x="123.42" y="-228.95" font-family="Times,serif" font-size="14.00">choice = &#39;coffee&#39; ?</text>
</g>
<!-- boil_water&#45;&gt;cond4 -->
<g id="edge6" class="edge">
<title>boil_water&#45;&gt;cond4</title>
<path fill="none" stroke="black" d="M123.42,-287.7C123.42,-280.41 123.42,-271.73 123.42,-263.54"/>
<polygon fill="black" stroke="black" points="126.92,-263.62 123.42,-253.62 119.92,-263.62 126.92,-263.62"/>
</g>
<!-- grind -->
<g id="node6" class="node">
<title>grind</title>
<ellipse fill="none" stroke="black" cx="86.42" cy="-162" rx="30.37" ry="18"/>
<text text-anchor="middle" x="86.42" y="-156.95" font-family="Times,serif" font-size="14.00">grind</text>
</g>
<!-- pour_water -->
<g id="node8" class="node">
<title>pour_water</title>
<ellipse fill="none" stroke="black" cx="123.42" cy="-90" rx="52.89" ry="18"/>
<text text-anchor="middle" x="123.42" y="-84.95" font-family="Times,serif" font-size="14.00">pour_water</text>
</g>
<!-- grind&#45;&gt;pour_water -->
<g id="edge7" class="edge">
<title>grind&#45;&gt;pour_water</title>
<path fill="none" stroke="black" d="M95.19,-144.41C99.37,-136.51 104.47,-126.85 109.19,-117.94"/>
<polygon fill="black" stroke="black" points="112.17,-119.77 113.75,-109.29 105.98,-116.5 112.17,-119.77"/>
</g>
<!-- dip -->
<g id="node7" class="node">
<title>dip</title>
<ellipse fill="none" stroke="black" cx="161.42" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="161.42" y="-156.95" font-family="Times,serif" font-size="14.00">dip</text>
</g>
<!-- dip&#45;&gt;pour_water -->
<g id="edge8" class="edge">
<title>dip&#45;&gt;pour_water</title>
<path fill="none" stroke="black" d="M152.61,-144.76C148.32,-136.87 143.05,-127.16 138.18,-118.18"/>
<polygon fill="black" stroke="black" points="141.29,-116.57 133.44,-109.45 135.14,-119.91 141.29,-116.57"/>
</g>
<!-- drink -->
<g id="node9" class="node">
<title>drink</title>
<ellipse fill="none" stroke="black" cx="123.42" cy="-18" rx="30.37" ry="18"/>
<text text-anchor="middle" x="123.42" y="-12.95" font-family="Times,serif" font-size="14.00">drink</text>
</g>
<!-- pour_water&#45;&gt;drink -->
<g id="edge9" class="edge">
<title>pour_water&#45;&gt;drink</title>
<path fill="none" stroke="black" d="M123.42,-71.7C123.42,-64.41 123.42,-55.73 123.42,-47.54"/>
<polygon fill="black" stroke="black" points="126.92,-47.62 123.42,-37.62 119.92,-47.62 126.92,-47.62"/>
</g>
<!-- cond1&#45;&gt;making_tea -->
<g id="edge10" class="edge">
<title>cond1&#45;&gt;making_tea</title>
<path fill="none" stroke="black" d="M67.97,-431.7C66.08,-424.32 63.81,-415.52 61.69,-407.25"/>
<polygon fill="black" stroke="black" points="65.08,-406.38 59.2,-397.57 58.3,-408.13 65.08,-406.38"/>
</g>
<!-- cond2&#45;&gt;making_coffee -->
<g id="edge11" class="edge">
<title>cond2&#45;&gt;making_coffee</title>
<path fill="none" stroke="black" d="M193.42,-431.7C193.42,-424.41 193.42,-415.73 193.42,-407.54"/>
<polygon fill="black" stroke="black" points="196.92,-407.62 193.42,-397.62 189.92,-407.62 196.92,-407.62"/>
</g>
<!-- cond3&#45;&gt;nochoice -->
<g id="edge12" class="edge">
<title>cond3&#45;&gt;nochoice</title>
<path fill="none" stroke="black" d="M312.64,-431.7C314.01,-424.32 315.64,-415.52 317.18,-407.25"/>
<polygon fill="black" stroke="black" points="320.58,-408.06 318.97,-397.59 313.7,-406.79 320.58,-408.06"/>
</g>
<!-- cond4&#45;&gt;grind -->
<g id="edge13" class="edge">
<title>cond4&#45;&gt;grind</title>
<path fill="none" stroke="black" d="M114.28,-215.7C110.14,-207.87 105.15,-198.44 100.55,-189.73"/>
<polygon fill="black" stroke="black" points="103.68,-188.17 95.92,-180.96 97.49,-191.44 103.68,-188.17"/>
</g>
<!-- cond4&#45;&gt;dip -->
<g id="edge14" class="edge">
<title>cond4&#45;&gt;dip</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M132.82,-215.7C137.18,-207.67 142.45,-197.95 147.28,-189.05"/>
<polygon fill="black" stroke="black" points="150.24,-190.93 151.94,-180.47 144.09,-187.59 150.24,-190.93"/>
</g>
</g>
</svg>

</html>

# Why

Building complex backend pipelines AFAIK requires creating pipeline definitions separate from the code itself. In my experience, this creates a lot of technical baggage. Futher, serverless backends (with AWS Lambda) gives us a lot of scalability but its hard to run locally. Also, Step Functions are great but without static checking, its very easy to get missing data errors while in production.

_Orchwipy_ tries to solve all these issues by having your code as the single source of truth about your data pipeline. Deployment templates, static checking, ... everything simply derives from it.

At [ask-next.com](https://ask-next.com) _Orchwipy_ orchestrates our data pipeline with ~50 services
